<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Community Reports — ICE Activity Tracker v10</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <nav class="top-nav" id="top-nav"></nav>
  <div class="breadcrumb" id="breadcrumb"></div>

  <div class="page-content">
    <h1 class="page-title">Community Reports</h1>
    <p class="page-subtitle">Submit and view community-contributed reports of ICE activity. All data is stored locally in your browser — nothing is sent to any server.</p>

    <div style="display:grid;grid-template-columns:minmax(280px,400px) 1fr;gap:1.5rem;align-items:start;">
      <div>
        <div class="card" style="margin-bottom:1rem;">
          <h3 style="font-size:.95rem;margin-bottom:.75rem;">Submit a Report</h3>
          <form id="report-form">
            <div class="form-group">
              <label for="rpt-state">State *</label>
              <input id="rpt-state" placeholder="e.g. CA" maxlength="2" required>
            </div>
            <div class="form-group">
              <label for="rpt-city">City</label>
              <input id="rpt-city" placeholder="Optional">
            </div>
            <div class="form-group">
              <label for="rpt-desc">Description</label>
              <textarea id="rpt-desc" rows="3" placeholder="What did you observe?"></textarea>
            </div>
            <button type="submit" class="btn-primary" style="border:none;border-radius:.375rem;padding:.5rem 1rem;font-family:inherit;font-size:.85rem;">Submit Report</button>
          </form>
        </div>
        <button id="btn-clear" style="font-size:.75rem;color:var(--accent-orange);background:none;border:none;cursor:pointer;font-family:inherit;">Clear all reports</button>
      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.75rem;">
          <h3 style="font-size:.95rem;">Your Reports</h3>
          <span id="report-count" style="font-size:.75rem;color:var(--text-muted)"></span>
        </div>
        <div id="report-list"></div>
      </div>
    </div>
  </div>

  <footer class="site-footer">Reports are unverified and stored only in this browser's localStorage.</footer>

  <script type="module">
    import { renderNav } from "../js/nav.js";
    import { getReports, saveReport, deleteReport, clearReports } from "../js/reports.js";

    renderNav("reports", ["Dashboard", "Reports"]);

    function formatDate(s) {
      try {
        const d = new Date(s);
        return d.toLocaleDateString("en-US", { month: "short", day: "numeric", hour: "2-digit", minute: "2-digit" });
      } catch { return ""; }
    }

    function render() {
      const reports = getReports();
      document.getElementById("report-count").textContent = `${reports.length} report${reports.length !== 1 ? "s" : ""}`;

      const list = document.getElementById("report-list");
      if (reports.length === 0) {
        list.innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:2rem">No reports yet. Submit one using the form.</p>';
        return;
      }

      list.innerHTML = reports.map(r => `
        <div class="news-item" style="cursor:default">
          <div style="display:flex;justify-content:space-between;align-items:start;">
            <div>
              <div class="title" style="color:var(--accent-orange)">${r.city ? r.city + ", " : ""}${r.state}</div>
              <div class="meta"><span>${formatDate(r.createdAt)}</span></div>
              ${r.description ? `<div class="desc">${r.description}</div>` : ""}
            </div>
            <button onclick="window.__deleteReport('${r.id}')" style="background:none;border:none;color:var(--text-muted);cursor:pointer;font-size:.75rem;padding:.25rem .5rem;" title="Delete">&times;</button>
          </div>
        </div>
      `).join("");
    }

    // Expose delete for inline handler
    window.__deleteReport = (id) => {
      if (confirm("Delete this report?")) {
        deleteReport(id);
        render();
      }
    };

    // Form submit
    document.getElementById("report-form").addEventListener("submit", (e) => {
      e.preventDefault();
      const state = document.getElementById("rpt-state").value.trim().toUpperCase();
      if (!state || state.length !== 2) { alert("Enter a valid 2-letter state code."); return; }
      saveReport({
        state,
        city: document.getElementById("rpt-city").value.trim(),
        description: document.getElementById("rpt-desc").value.trim(),
      });
      e.target.reset();
      render();
    });

    // Clear all
    document.getElementById("btn-clear").addEventListener("click", () => {
      if (confirm("Clear all your community reports? This cannot be undone.")) {
        clearReports();
        render();
      }
    });

    render();
  </script>
</body>
</html>
