<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Insights — ICE Activity Tracker v10</title>
  <link rel="stylesheet" href="../css/styles.css">
</head>
<body>
  <nav class="top-nav" id="top-nav"></nav>
  <div class="breadcrumb" id="breadcrumb"></div>

  <div class="page-content">
    <h1 class="page-title">AI Insights</h1>
    <p class="page-subtitle">AI-powered analysis of current ICE enforcement trends. Powered by Google Gemini.</p>

    <div class="ai-config" id="ai-config">
      <label for="ai-provider">AI Provider</label>
      <select id="ai-provider" style="background:var(--bg-primary);border:1px solid var(--border);border-radius:.375rem;padding:.5rem .75rem;font-size:.85rem;color:var(--text-primary);font-family:inherit;margin-bottom:.75rem;display:block;max-width:300px;">
        <option value="gemini">Google Gemini (free tier)</option>
      </select>

      <label for="ai-key">API Key</label>
      <input type="password" id="ai-key" placeholder="Paste your Gemini API key here">
      <div class="hint">Your key is stored in localStorage only. It is sent directly to the AI provider — never to any other server. Get a free key at <a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener noreferrer">aistudio.google.com/apikey</a></div>
      <button id="btn-save-key" class="btn-primary" style="margin-top:.75rem;padding:.5rem 1rem;border-radius:.375rem;border:none;font-family:inherit;font-size:.85rem;">Save Key</button>
    </div>

    <div class="filters">
      <button id="btn-summary" class="btn-primary">Generate Summary</button>
      <select id="state-select">
        <option value="">State-specific analysis...</option>
      </select>
      <button id="btn-state">Analyze State</button>
    </div>

    <div id="ai-output"></div>

    <div style="margin-top:2rem;">
      <h2 style="font-size:1.1rem;margin-bottom:.75rem;">Activity by State</h2>
      <div id="state-chart"></div>
    </div>
  </div>

  <footer class="site-footer">AI analysis is generated by Gemini and may contain inaccuracies. Verify all information independently.</footer>

  <script type="module">
    import { renderNav } from "../js/nav.js";
    import { fetchAllNews, ALL_ABBREVS } from "../js/news.js";
    import { getApiKey, setApiKey, getProvider, setProvider, queryAI, buildSummaryPrompt, buildStatePrompt } from "../js/ai.js";

    renderNav("analytics", ["Dashboard", "AI Insights"]);

    // Populate state dropdown
    const stateSelect = document.getElementById("state-select");
    ALL_ABBREVS.sort().forEach(s => {
      const opt = document.createElement("option");
      opt.value = s; opt.textContent = s;
      stateSelect.appendChild(opt);
    });

    // Load saved key
    const keyInput = document.getElementById("ai-key");
    keyInput.value = getApiKey();
    document.getElementById("ai-provider").value = getProvider();

    document.getElementById("btn-save-key").addEventListener("click", () => {
      setApiKey(keyInput.value);
      setProvider(document.getElementById("ai-provider").value);
      showOutput("API key saved.", "green");
    });

    function showOutput(content, color) {
      document.getElementById("ai-output").innerHTML = `
        <div class="ai-panel">
          <div class="ai-label">AI Analysis</div>
          <div class="ai-content" style="${color ? `color:var(--accent-${color})` : ''}">${content}</div>
        </div>
      `;
    }

    function showLoading() {
      document.getElementById("ai-output").innerHTML = `
        <div class="ai-panel">
          <div class="ai-label">Generating...</div>
          <div class="spinner"></div>
        </div>
      `;
    }

    function markdownToHtml(text) {
      return text
        .replace(/\*\*(.+?)\*\*/g, "<strong>$1</strong>")
        .replace(/\*(.+?)\*/g, "<em>$1</em>")
        .replace(/^### (.+)$/gm, "<h4>$1</h4>")
        .replace(/^## (.+)$/gm, "<h3>$1</h3>")
        .replace(/^# (.+)$/gm, "<h2>$1</h2>")
        .replace(/^- (.+)$/gm, "&bull; $1")
        .replace(/\n/g, "<br>");
    }

    // Summary
    document.getElementById("btn-summary").addEventListener("click", async () => {
      showLoading();
      try {
        const news = await fetchAllNews();
        if (news.length === 0) { showOutput("No news data available to analyze.", "orange"); return; }
        const prompt = buildSummaryPrompt(news);
        const result = await queryAI(prompt);
        showOutput(markdownToHtml(result));
      } catch (e) {
        showOutput(e.message, "red");
      }
    });

    // State analysis
    document.getElementById("btn-state").addEventListener("click", async () => {
      const state = stateSelect.value;
      if (!state) { showOutput("Select a state first.", "orange"); return; }
      showLoading();
      try {
        const news = await fetchAllNews();
        const prompt = buildStatePrompt(state, news);
        if (!prompt) { showOutput(`No news items found for ${state}.`, "orange"); return; }
        const result = await queryAI(prompt);
        showOutput(markdownToHtml(result));
      } catch (e) {
        showOutput(e.message, "red");
      }
    });

    // State chart (simple bar chart)
    (async () => {
      try {
        const news = await fetchAllNews();
        const counts = {};
        news.forEach(n => { if (n.state) counts[n.state] = (counts[n.state] || 0) + 1; });
        const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 15);
        const max = sorted[0]?.[1] || 1;

        document.getElementById("state-chart").innerHTML = sorted.map(([state, count]) => `
          <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.35rem;">
            <span style="width:2rem;text-align:right;font-size:.75rem;color:var(--text-secondary)">${state}</span>
            <div style="flex:1;background:var(--bg-secondary);border-radius:.25rem;overflow:hidden;height:1.25rem;">
              <div style="width:${(count/max)*100}%;background:var(--accent-blue);height:100%;border-radius:.25rem;display:flex;align-items:center;padding-left:.5rem;">
                <span style="font-size:.65rem;color:#fff;font-weight:600">${count}</span>
              </div>
            </div>
          </div>
        `).join("");
      } catch { /* ignore */ }
    })();
  </script>
</body>
</html>
